<?php
/**
 * Author: Damian Schwyrz <mail@damianschwyrz.de>
 * URL: https://www.damianschwyrz.de
 * Copyright (c) 2018.
 */

namespace App\Task;

use App\Target;
use Carbon\Carbon;

class BatchProcessSubdomainsFoundViaMassDNS
{
    protected $project;

    public function setProject($project)
    {
        $this->project = $project;
    }

    public function start(string $rawSubdomainlist)
    {
        $subdomains = $this->splitFiledataIntoLines($rawSubdomainlist);
        $subdomains = $this->trimSubdomains($subdomains);
        $subdomains = $this->toLowerCase($subdomains);
        $subdomains = $this->dropEmptyLines($subdomains);
        $subdomains = $this->splitMassDnsSubdomainLine($subdomains);

        $subdomains = array_unique($subdomains);
        $subdomains = $this->dropAllSubdomainsWhichExistInDatabase($subdomains);

        $data = $this->createImportData($subdomains);

        Target::insert($data);
    }

    /**
     * @param string $rawSubdomainlist
     *
     * @return array|false|string[]
     */
    protected function splitFiledataIntoLines(string $rawSubdomainlist)
    {
        return preg_split("/\r\n|\n|\r/", $rawSubdomainlist);
    }

    /**
     * @param $subdomains
     *
     * @return array
     */
    protected function trimSubdomains(array $subdomains): array
    {
        return array_map(function ($string) {
            return trim($string);
        }, $subdomains);
    }

    /**
     * @param $subdomains
     *
     * @return array
     */
    protected function toLowerCase(array $subdomains): array
    {
        return array_map(function ($string) {
            return strtolower($string);
        }, $subdomains);
    }

    /**
     * @param $subdomains
     *
     * @return array
     */
    protected function dropEmptyLines(array $subdomains): array
    {
        return array_filter($subdomains, function ($string) {
            return !empty($string);
        });
    }

    /**
     * @param $subdomains
     *
     * @return array
     */
    protected function splitMassDnsSubdomainLine($subdomains): array
    {
        $subdomainsT = [];

        foreach ($subdomains as $subdomainLine) {
            $line = explode(" ", $subdomainLine);
            $subdomain = $line[0];
            $subdomainsT[] = $this->removeLastDotFromString($subdomain);
        }

        $subdomains = $subdomainsT;

        return $subdomains;
    }

    /**
     * @param $subdomain
     *
     * @return bool|string
     */
    protected function removeLastDotFromString(string $subdomain): string
    {
        if (substr($subdomain, -1) == ".") {
            return substr($subdomain, 0, -1);
        }

        return $subdomain;
    }

    /**
     * @param $subdomains
     *
     * @return array
     */
    protected function dropAllSubdomainsWhichExistInDatabase(array $subdomains): array
    {
        $existingTargets = $this->project->targets()->get()->pluck('subdomain')->flatten()->values();

        return array_filter($subdomains, function ($string) use ($existingTargets) {

            if (is_integer($existingTargets->search($string))) {
                return false;
            }

            return true;
        });
    }

    /**
     * @param $subdomains
     *
     * @return array
     */
    protected function createImportData(array $subdomains): array
    {
        $data = [];
        $now = Carbon::now('utc')->toDateTimeString();

        foreach ($subdomains as $domain) {

            $data[] = [
                'subdomain'  => $domain,
                'status'     => 'new',
                'project_id' => $this->project->id,
                'created_at' => $now,
                'updated_at' => $now,
            ];
        }

        return $data;
    }

}