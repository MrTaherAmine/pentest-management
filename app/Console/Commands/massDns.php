<?php

namespace App\Console\Commands;

use App\AdminNotice;
use App\Project;
use App\System\WildCardDomain;
use App\Task\BatchProcessSubdomainsFoundViaMassDNS;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\File;
use Symfony\Component\Process\Process;

class massDns extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'massdns:scan
    {--project=0 : Project ID}
    {--domain=2 : Domain without http(s) or slashes}
    {--wordlist=quick.txt : Subdomain wordlist}
    {--interval=500 : Interval in milliseconds to wait between multiple resolves of the same domain.}';

    /**
     * @var
     */
    protected $project;

    /**
     * @var string
     */
    protected $cmd = "";

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Perform a subdomain enumeration using massdns';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return mixed
     */
    public function handle()
    {
        list($projectId, $domain, $interval, $wordlist) = $this->getArguments();

        $wordlist = base_path("toolset/wordlists/subdomains/" . $wordlist);
        $resolver = base_path("toolset/wordlists/dns/resolvers.txt");

        $this->validateArguments($projectId, $domain, $interval, $wordlist, $resolver);


        $this->wildCardDomainTest($domain);

        $this->project = Project::findOrFail($projectId);

        $outputPath = $this->makeOutputFileAndPath($domain, $projectId);

        $this->cmd = $this->createCommand($wordlist, $domain, $resolver, $interval, $outputPath);

        $this->line($this->cmd);

        AdminNotice::create([
            'type'    => 'success',
            'context' => "massdns:scan",
            'message' => "Execution started",
            'cmd'     => $this->cmd,
        ]);

        $this->executeCommand($this->cmd);

        $this->checkIfReportWasCreated($outputPath);

        $this->importMassDNSDataToDB($outputPath);


        $message = "Process finished, report saved to file and database.";
        $this->info($message);

        AdminNotice::create([
            'type'    => 'success',
            'context' => 'massdns:scan',
            'message' => $message,
            'cmd'     => $this->cmd,
        ]);
    }

    /**
     * @return array
     */
    protected function getArguments(): array
    {
        $projectId = $this->option("project");
        $domain = $this->option("domain");
        $interval = $this->option("interval");
        $wordlist = $this->option("wordlist");

        return [$projectId, $domain, $interval, $wordlist];
    }

    /**
     * @param $projectId
     * @param $domain
     * @param $interval
     * @param $wordlist
     * @param $resolver
     */
    protected function validateArguments($projectId, $domain, $interval, $wordlist, $resolver)
    {
        $message = "";
        $abort = false;

        if ($projectId <= 0) {
            $abort = true;
            $message = "projectId has to be bigger than 0";
        }

        if (strlen($domain) < 4) {
            $abort = true;
            $message = "domain not set or too small";
        }

        if ($interval <= 0) {
            $abort = true;
            $message = "Interval not set or too small";
        }

        if (!File::exists($wordlist)) {
            $abort = true;
            $message = "Wordlist does not exist.";
        }

        if (!File::exists($resolver)) {
            $abort = true;
            $message = "Resolverlist does not exist.";
        }

        if ($abort) {
            $this->error($message);

            AdminNotice::create([
                'type'    => 'error',
                'context' => "massdns:scan",
                'message' => $message,
                'cmd'     => $this->cmd,
            ]);

            exit();

        }
    }

    /**
     * @param $domain
     */
    protected function wildCardDomainTest(string $domain): void
    {
        $wildcard = new WildCardDomain($domain);
        $wildcard->test();

        if ($wildcard->isWildcardDomain()) {
            $message = "Wildcard domain detected... ";

            $this->error($message);

            AdminNotice::create([
                'type'    => 'error',
                'context' => 'massdns:scan',
                'message' => $message,
                'cmd'     => $domain,
            ]);

            exit();
        }
    }

    /**
     * @param $domain
     * @param $projectId
     *
     * @return string
     */
    protected function makeOutputFileAndPath($domain, $projectId): string
    {
        $outputFile = str_slug($domain) . "-" . $projectId . ".text";
        $outputPath = storage_path("app/public/massdns/" . $outputFile);

        return $outputPath;
    }

    /**
     * @param $wordlist
     * @param $domain
     * @param $resolver
     * @param $interval
     * @param $outputPath
     *
     * @return string
     */
    protected function createCommand($wordlist, $domain, $resolver, $interval, $outputPath): string
    {
        $cmd = [];
        $cmd[] = config('toolset.bin.python3');
        $cmd[] = config("toolset.path.subbrute");
        $cmd[] = $wordlist;
        $cmd[] = $domain;
        $cmd[] = "|";
        $cmd[] = config("toolset.path.massdns");
        $cmd[] = "-r " . $resolver;
        $cmd[] = "-t A";
        $cmd[] = "-o S";
        $cmd[] = "-i " . $interval;
        $cmd[] = "-w " . $outputPath;

        $cmd = implode(" ", $cmd);

        return $cmd;
    }

    /**
     * @param $cmd
     */
    protected function executeCommand($cmd): void
    {
        $process = new Process($cmd);

        $process->setTimeout(
            config("toolset.massdns.timeout")
        );

        $process->start();

        $process->wait(function ($type, $buffer) {
            if (Process::ERR === $type) {
                $this->line($buffer);
            } else {
                $this->line($buffer);
            }
        });
    }

    /**
     * @param $outputPath
     */
    protected function checkIfReportWasCreated($outputPath): void
    {
        if (!File::exists($outputPath)) {
            $message = "Failed importing report... no report found";

            $this->warn($message);

            AdminNotice::create([
                'type'    => 'warning',
                'context' => 'massdns:scan',
                'message' => $message,
                'cmd'     => $this->cmd,
            ]);

            exit();
        }
    }

    /**
     * @param $outputPath
     */
    protected function importMassDNSDataToDB($outputPath): void
    {
        $subdomains = File::get($outputPath);
        $domainAdder = new BatchProcessSubdomainsFoundViaMassDNS();
        $domainAdder->setProject($this->project);
        $domainAdder->start($subdomains);
    }
}
