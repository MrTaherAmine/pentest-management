<?php
/**
 * Author: Damian Schwyrz <mail@damianschwyrz.de>
 * URL: https://www.damianschwyrz.de
 * Copyright (c) 2018.
 */

namespace App\Console\Commands;

use App\AdminNotice;
use App\Target;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\File;
use Symfony\Component\Process\Process;

class NMapPortscan extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'nmap:scan 
    {--target=0 : Target ID in database} 
    {--quick : perform only quick scan} 
    {--ports=1-1000 : scan selected ports}';

    /**
     * The console command description.
     *
     *
     * @var string
     */
    protected $description = 'Scans selected port using nmap.';
    /**
     * @var \App\Target
     */
    protected $target;

    /**
     * @var string
     */
    protected $cmd = "";

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return mixed
     */
    public function handle()
    {
        list($targetId, $quickScan, $ports) = $this->getArguments();

        $this->validateArguments($targetId);

        $this->target = Target::findOrFail($targetId);

        list($outputFile, $outputPath) = $this->makeOutputFileAndPath();

        $this->cmd = $this->createCommand($quickScan, $ports, $outputPath);

        AdminNotice::create([
            'type'    => 'success',
            'context' => 'nmap:scan',
            'message' => "Execution started",
            'cmd'     => $this->cmd,
        ]);

        $this->executeCmd($this->cmd);

        $this->checkIfReportWasCreated($outputPath);

        $reportContent = "Full Report: " . asset("storage/portscan/" . $outputFile) . "\n\n";
        $reportContent .= File::get($outputPath);

        $this->target->open_ports = $reportContent;
        $this->target->save();

        $message = "Process finished, report saved to file and database.";

        $this->line($message);

        AdminNotice::create([
            'type'    => 'success',
            'context' => 'nmap:scan',
            'message' => $message,
            'cmd'     => $this->cmd,
        ]);

    }

    /**
     * @return array
     */
    protected function getArguments(): array
    {
        $targetId = $this->option("target");
        $quickScan = $this->option("quick");
        $ports = $this->option("ports");

        return [$targetId, $quickScan, $ports];
    }

    /**
     * @param $targetId
     */
    protected function validateArguments(int $targetId): void
    {

        $message = "";
        $abort = false;

        if ($targetId <= 0) {
            $abort = true;
            $message = "targetID has to be bigger than 0";
        }

        if ($abort) {
            $this->error($message);

            AdminNotice::create([
                'type'    => 'error',
                'context' => 'nmap:scan',
                'message' => $message,
                'cmd'     => $this->cmd,
            ]);

            exit();

        }

    }

    /**
     * @return array
     */
    protected function makeOutputFileAndPath(): array
    {
        $outputFile = str_slug($this->target->subdomain) . "-" . $this->target->id . ".txt";
        $outputPath = storage_path("app/public/portscan/" . $outputFile);

        return [$outputFile, $outputPath];
    }

    /**
     * @param $quickScan
     * @param $ports
     * @param $outputPath
     *
     * @return array|string
     */
    protected function createCommand($quickScan, $ports, $outputPath)
    {
        $cmd = [];

        $cmd[] = config("toolset.bin.nmap");

        if ($quickScan) {
            $cmd[] = "-F";
        } else {
            $cmd[] = "-p " . $ports;
        }

        $cmd[] = '-oN ' . $outputPath;
        $cmd[] = $this->target->subdomain;

        $cmd = implode(" ", $cmd);

        return $cmd;
    }

    /**
     * @param string $finaleCommand
     */
    protected function executeCmd(string $finaleCommand)
    {
        $process = new Process($finaleCommand);

        $process->setTimeout(
            config("toolset.nmap.timeout")
        );

        $process->disableOutput();
        $process->run();
    }

    /**
     * @param string $outputPath
     */
    protected function checkIfReportWasCreated(string $outputPath): void
    {
        if (!File::exists($outputPath)) {
            $message = "Failed importing report... no report found";

            $this->warn($message);

            AdminNotice::create([
                'type'    => 'warning',
                'context' => 'nmap:scan',
                'message' => $message,
                'cmd'     => $this->cmd,
            ]);

            exit();
        }
    }
}
