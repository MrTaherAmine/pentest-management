/*
 * Author: Damian Schwyrz <mail@damianschwyrz.de>
 * URL: https://www.damianschwyrz.de
 * Copyright (c) 2018.
 */


$(function () {


    $('#prepare-wpscan-modal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var url = button.data("url");
        var route = button.data("href");


        $("#start-wpscan").data("route", route);
        $("#start-wpscan").attr("data-route", route);

        $("#wpscan-url").val(url);
    });

    $('#prepare-wpscan-modal').on('hide.bs.modal', function () {
        $("#wpscan-url").val("");
        $("#start-wpscan").find(".fa").addClass("hidden");
    });

    $(document).on('click', "#start-wpscan", function (event) {
        event.preventDefault();
        var route = $(this).data("route");
        var url = $("#wpscan-url").val();
        var threads = parseInt($("#wpscan-threads").val());
        var uIDStart = parseInt($("#wpscan-usernames-start").val());
        var uIDEnd = parseInt($("#wpscan-usernames-end").val());
        var plugins = $("#wpscan-plugins").val();
        var themes = $("#wpscan-themes").val();

        if (threads <= 0 || isNaN(threads)) {
            wpscanError("Threadscount has to be bigger than 0!");
            return false;
        }

        if (route == "") {
            wpscanError("Route not found!");
            return false;
        }

        if (url == "") {
            wpscanError("URL has to be set!");
            return false;
        }

        if (uIDStart < 1 || isNaN(uIDStart)) {
            wpscanError("uIDStart has to be set!");
            return false;
        }

        if (uIDEnd < 1 || isNaN(uIDEnd)) {
            wpscanError("uIDEnd has to be set!");
            return false;
        }

        if (plugins != "p" && plugins != "ap" && plugins != "vp") {
            wpscanError("Plugins invalid");
            return false;
        }

        if (themes != "t" && themes != "at" && themes != "vt") {
            wpscanError("Themes invalid");
            return false;
        }


        $(this).find(".fa").removeClass("hidden");

        $.ajax({
            url: route,
            type: 'POST',
            data: {
                url: url,
                threads: threads,
                uidstart: uIDStart,
                uidend: uIDEnd,
                plugins: plugins,
                themes: themes
            },
            success: function (result) {
            },
            error: function (result) {
                loadInfoBox("#infobox", "Problem occured while starting wpscan.");
            },
            complete: function (result) {
                console.log(result);
                $('#prepare-wpscan-modal').modal('hide');

                loadInfoBox("#infobox", "Dirscan is in queue - come back later ;)");
            }
        });

    });
});

function wpscanError(message) {

    $("#wpscan-error .alert span").html(message);
    $("#wpscan-error").fadeIn();

    setTimeout(function () {
        $("#wpscan-error").fadeOut("fast");
        $("#wpscan-error .alert span").html("");

    }, 3200);
}